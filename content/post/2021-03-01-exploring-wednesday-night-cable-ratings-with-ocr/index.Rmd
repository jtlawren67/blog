---
title: Exploring Wednesday Night Cable Ratings with OCR
author: JLaw
date: '2021-03-01'
slug: exploring-wednesday-night-cable-ratings-with-ocr
categories:
  - R
tags:
  - magick
  - tesseract
  - patchwork
subtitle: ''
summary: ''
authors: []
lastmod: '2021-02-13T16:25:16-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)
```


One of my guilty pleasure TV shows is [MTV's The Challenge](https://en.wikipedia.org/wiki/The_Challenge_(TV_series)).  Debuting in the late 90s, the show pitted alumni from The Real World and Road Rules against each other in a series of physical events.  Now on its 36th season, its found new popularity by importing challengers from other Reality Shows in the US and Internationally regularly topping Wednesday Night ratings in the coveted 18-49 demographic.

Looking at the Ratings on [showbuzzdaily.com](http://www.showbuzzdaily.com/articles/showbuzzdailys-top-150-wednesday-cable-originals-network-finals-2-3-2021.html) shows that the Challenge was in fact #1 on this demographic, but also scores incredibly low on the 50+ demo.  

![](ratings.PNG)

So I figured that exploring the age and gender distributions of Wednesday Night Cable ratings would be interesting.  The only caveat is... **the data exists in an image**.

So for this blog post, I will be extracting the ratings data from the image and doing some exploration on popular shows by age and gender.  

Also, huge thanks to Thomas Mock and his [The Mockup Blog](https://themockup.blog/posts/2021-01-18-reading-tables-from-images-with-magick/) for serving as a starting point for learning `magick`.

## Using magick to process image data

I'll be using the `magick` package to read in the image and do some processing to clean up the image.  Then I will use the *ocr()* function from the `tesseract` package to actual handle extracting the data from the image.

```{r libraries}
library(tidyverse) #Data Manipulation
library(magick) #Image Manipulation
library(tesseract) #Extracting Text from the Image
library(patchwork) #Combining Multiple GGPLOTs Together
```

The first step is reading in the raw image from the [showbuzzdaily.com](http://www.showbuzzdaily.com/articles/showbuzzdailys-top-150-wednesday-cable-originals-network-finals-2-3-2021.html) website which can be done through `magick`'s *image_read()* function.

```{r}
raw_img <- image_read("http://www.showbuzzdaily.com/wp-content/uploads/2021/02/Final-Cable-2021-Feb-03-WED.png")

image_ggplot(raw_img)
```

The next thing to notice is that while most of the data does exist in a tabular format, there are also headers and footers that don't follow the tabular structure.  So I'll use *image_crop()* to keep only the tabular part of the image.  The crop function uses a *geometry_area()* helper function which takes in four parameters.  I struggled a bit with the documentation figuring out exactly how to get this working right but eventually internalized *geometry_area(703, 1009, 0, 91)* as "crop out 703 pixels of width and 1009 pixels of height starting from X-position on the left boundary and y-position 91 pixels from the top".

```{r cropping}
chopped_image <- 
  raw_img %>% 
  #crop out width:703px and height:1009px starting +91px from the top
  image_crop(geometry_area(703, 1009, 0, 91)) 

image_ggplot(chopped_image)

```

Now the non-tabular data (header and footer) have been removed.

The *ocr()* algorithm that will handle extracting the data from the image can struggle sometimes with parts of the image as is.  For example, it might think the color boundary between white and green is a character.  Therefore, I'm going to try to do the best I can do clean up the image so that the *ocr()* function can have an easier time.  Ultimately this required a lot of guess and check but in the end, I only did two steps for cleaning:

1. Running a thinning filter over the image to remove the horizontal lines separating each group of 5 shows (this required negating the colors of the image so that the filter would have an easier time).
2. Turning everything to greyscale.

I had tried to actually remove the color gradients, but it took much more effort and was ultimately not more effective than just going to greyscale.

```{r processing}
processed_image <- chopped_image %>% 
  image_negate() %>% #Flip the Colors
  # Remove the Horizontal Lines
  image_morphology(method = "Thinning", kernel = "Rectangle:7x1") %>% 
  # Flip the Colors back to the original
  image_negate() %>% 
  # Turn colors to greyscale
  image_quantize(colorspace = "gray")


image_ggplot(processed_image)

```

## Extracting the Data with OCR

Because I can be lazy, my first attempts at extraction was just to run *ocr()* on the processed image and hope for the best.  However, the best was somewhat frustrating.  For example,

```{r}
ocr(processed_image) %>% 
  str_sub(end = str_locate(., '\\n')[1])
```
Just looking at the top row there are a number of issues that come from just using *ocr()* directly on the table.  The boundary between sections are showing up as "|" or "/" and sometime the decimal doesn't appear.

Fortunately the function allows you to "whitelist" characters in order to nudge the algorithm on what it should expect to see.  So rather than guess and check on the processing of the image to make everything work perfectly.  I'll write a function that allows me to crop to individual columns and specific the proper whitelist for each column.

```{r}
ocr_text <- function(col_width, col_start, format_code){
  
  ##Formats
  only_chars <- tesseract::tesseract(
    options = list(
      tessedit_char_whitelist = paste0(LETTERS, collapse = '')
    )
  )
  
  all_chars <- tesseract::tesseract(
    options = list(
      tessedit_char_whitelist = paste0(
        c(LETTERS, " ", ".0123456789-()/"), collapse = "")
    )
  )
  
  ratings <- tesseract::tesseract(
    options = list(
      tessedit_char_whitelist = "0123456789 ."
    )
  )
  
  population <- tesseract::tesseract(
    options = list(
      tessedit_char_whitelist = "0123456789,"
    )
  )
  
  tmp <- processed_image %>% 
    image_crop(geometry_area(col_width, 1009, col_start, 0)) 
  
  tmp %>% 
    ocr(engine = get(format_code)) %>% 
    str_split("\n") %>%
    unlist() %>%
    enframe() %>%
    select(-name) %>%
    filter(!is.na(value), str_length(value) > 0)
}
```

The function above takes in a column width and a column start to crop the column and then a label to choose the whitelist for each specific column.  The parameters are defined in a list and passed into `purrr`'s *pmap()* function.  Finally, all the extracted columns will combined together.

```{r}
all_ocr <- list(col_width = c(168, 37, 33, 34, 35, 34),
                col_start = c(28, 196, 307, 346, 385, 598),
                format_code = c("all_chars", 'only_chars', rep("ratings", 4))) %>% 
  pmap(ocr_text) 

ratings <- all_ocr %>% 
  bind_cols() %>% 
  set_names(nm = "telecast", "network", "p_18_49", "f_18_49", "m_18_49",
            'p_50_plus') 
```

## Final Cleaning

Even with the column specific specifications the *ocr()* function did not get everything right.  Due to the font, it has particular troubles distinguishing between `1`s and `4`s as well as `8`s and `6`s.  Additionally, sometimes the decimal was still missed, and then I just decided to recode the networks manually.

```{r cleaning}
ratings_clean <- ratings %>% 
  #Fix Things where the decimal was missed
  mutate(across(p_18_49:p_50_plus, ~parse_number(.x)),
         across(p_18_49:p_50_plus, ~if_else(.x > 10, .x/100, .x)),
         #1s and 4s get kindof screwed up; same with 8s and 6s
         p_50_plus = case_when(
           telecast == 'TUCKER CARLSON TONIGHT' ~ 2.71,
           telecast == 'SISTAS SERIES S2' ~ 0.46,
           telecast == 'LAST WORD W/L. ODONNEL' ~ 2.17,
           telecast == 'SITUATION ROOM' & p_50_plus == 1.34 ~ 1.31,
           telecast == 'MY 600-LB LIFE NIA' ~ 0.46,
           TRUE ~ p_50_plus
         ),
         #Clean up 'W/' being read as 'WI' and '11th' as '44th'
         telecast = case_when(
           telecast == '44TH HOUR WIB. WILLIAMS' ~ '11TH HOUR W/B. WILLIAMS',
           telecast == 'ALLIN WI CHRIS HAYES' ~ 'ALL IN W/ CHRIS HAYES',
           telecast == 'BEAT WIARI MELBER' ~'BEAT W/ARI MELBER',
           telecast == 'SPORTSCENTER 124M L' ~ 'SPORTSCENTER 12AM',
           TRUE ~ telecast
         ),
         # Turn to Title Case
         telecast = str_to_title(telecast),
         # Clean up random characters
         telecast = str_remove(telecast, ' [L|F|S2|L B]+$'),
         #Clean up Network
         network = factor(case_when(
           network == 'TURNI' ~ "TNT",
           network == 'MSNBI' ~ "MSNBC",
           network == 'FOXN' ~ "FoxNews",
           network == 'LIFETI' ~ "Lifetime",
           network == 'BLACK' ~ 'BET',
           network %in% c('AEN', 'AGEN') ~ 'A&E',
           network == 'BRAVC' ~ 'BRAVO',
           network == 'COME' ~ 'COMEDY CENTRAL',
           network == 'NECS' ~ 'NBC SPORTS',
           network == 'TBSN' ~ 'TBS',
           network == 'TL' ~ 'TLC',
           TRUE ~ network
         ))
  )

knitr::kable(head(ratings_clean, 3))

```

But now everything should be ready for analysis.

## Analysis of Cable Ratings

The decimals in the table for cable ratings refer to the percent of the population watching the show.  For instance the `p_18_49` field's value of 0.54 means that 0.54% of the US 18-49 population watched The Challenge on February 3rd.

### The Most Popular Shows on Wednesday Night Overall 18-49 and By Gender

The first question is what are the most popular shows for the 18-49 demographic for combined genders and broken apart by gender.  These types of combined plots uses the `patchwork` package to combine the three ggplots into a single plot using a common legend.

```{r most_popular_18_49}
##Create Fixed Color Palette For Networks
cols <- scales::hue_pal()(n_distinct(ratings_clean$network))
names(cols) <- levels(ratings_clean$network)

##Top Show By the Key Demo (By Male, By Female)
key_all <- ratings_clean %>% 
  slice_max(p_18_49, n = 10) %>% 
  ggplot(aes(x = fct_reorder(telecast, p_18_49), y = p_18_49, fill = network)) + 
    geom_col() + 
    geom_text(aes(label = p_18_49 %>% round(2)), nudge_y = 0.015) + 
    scale_y_continuous(expand = expansion(mult = c(0, .1))) + 
    scale_fill_manual(values = cols) + 
    labs(x = "", title = "All Genders", y = '', fill = '') + 
    coord_flip() + 
    cowplot::theme_cowplot() + 
    theme(
      axis.text.x = element_blank(),
      axis.ticks = element_blank(),
      axis.line.x = element_blank(),
      plot.title.position = 'plot'
    )

key_male <- ratings_clean %>% 
  slice_max(m_18_49, n = 5) %>% 
  ggplot(aes(x = fct_reorder(telecast, m_18_49), y = m_18_49, fill = network)) + 
  geom_col() + 
  geom_text(aes(label = m_18_49 %>% round(2)), nudge_y = .025) + 
  scale_y_continuous(expand = expansion(mult = c(0, .1))) + 
  scale_fill_manual(values = cols, guide = F) + 
  labs(x = "", title = "Male", y = '') + 
  coord_flip() + 
  cowplot::theme_cowplot() + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.line.x = element_blank(),
    plot.title.position = 'plot'
  )

key_female <- ratings_clean %>% 
  slice_max(f_18_49, n = 5) %>% 
  ggplot(aes(x = fct_reorder(telecast, f_18_49), y = f_18_49, fill = network)) + 
  geom_col() + 
  geom_text(aes(label = f_18_49 %>% round(2)), nudge_y = .035) + 
  scale_y_continuous(expand = expansion(mult = c(0, .1))) + 
  scale_fill_manual(values = cols, guide = F) + 
  labs(x = "", title = "Female", y = '') + 
  coord_flip() + 
  cowplot::theme_cowplot() + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.line.x = element_blank(),
    plot.title.position = 'plot'
  )
    

key_all / (key_male | key_female) +
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "**Wednesday Night Cable Ratings (Feb 3rd, 2021)**",
    caption = "*Source:* Showbuzzdaily.com"
  ) & theme(legend.position = 'bottom',
            plot.title = ggtext::element_markdown(size = 14),
            plot.caption = ggtext::element_markdown())

```

From the chart its clear that the Challenge is fairly dominent in the 18-49 Demographic with 0.21% (or 1.63x) higher than the 2nd highest show.  Although while the Challenge is popular with both genders its the most popular shows amongst 18-49 Females but only 3rd for 18-49 Males after a NBA game and AEW Professional Wrestling.

### The Most Male-Dominant, Female Dominant, and Gender-Balanced Shows

From the above chart its clear that some shows skew Male (sports) and some skew Female (reality shows like Married at First Sight and My 600-lb Life).  But I can look at that more directly by comparing the ratios the Female 18-49 rating to the Male 18-49 rating to determine the gender skew of each show.  I break the shows into categories of *Male Skewed*, *Female Skewed*, and *Balanced*.

```{r gender_break}
##Female / Male Ratio for Key Demo
bind_rows(
  ratings_clean %>% 
    mutate(f_m_ratio = f_18_49 / m_18_49) %>%
    slice_max(f_m_ratio, n = 5),
  ratings_clean %>% 
    mutate(f_m_ratio = f_18_49 / m_18_49) %>%
    slice_min(f_m_ratio, n = 5),
  ratings_clean %>% 
    mutate(f_m_ratio = f_18_49 / m_18_49,
           balance = abs(1-f_m_ratio)) %>% 
    slice_min(balance, n = 5)
) %>%
  mutate(balance = f_m_ratio-1) %>% 
  ggplot(aes(x = m_18_49, y = f_18_49, fill = balance)) + 
    ggrepel::geom_label_repel(aes(label = telecast)) + 
    geom_abline(lty = 2) + 
    scale_fill_gradient2(high = '#8800FF',mid = '#BBBBBB', low = '#02C2AD',
                         midpoint = 0, guide = F) + 
    labs(title = "Comparing 18-49 Demographics by Gender",
         subtitle = 'Cable Feb 3rd, 2021',
         caption = "*Source:* showbuzzdaily.com",
         x = "Males 18-49 Ratings",
         y = "Females 18-49 Ratings") + 
    cowplot::theme_cowplot() + 
    theme(
      plot.title.position = 'plot',
      plot.caption = ggtext::element_markdown()
    )

```

Sure enough the most Male dominated shows are sport-related with 2 NBA Games, an NBA pre-gram show, an episode of Sportscenter, and a sports talking heads show.  Female skewed shows are also not surprising with Married at First Sight, Sistas, My 600-lb Life, and Real Housewives of Salt Lake City topping the list.  For the balanced category, I did not have much of an expectation but all the programs seems to be News shows or news adjacent like the Daily Show... which I guess makes sense.

### Most Popular Shows for the 50+ Demographic

Turning away from the 18-49 demographic I can also look at the most popular shows for the 50+ demographic.  Unfortuntaely, there is not a 50+ gender breakdown so I can only look at the overall.

```{r plus50_overall}
ratings_clean %>% 
  slice_max(p_50_plus, n = 10) %>% 
  ggplot(aes(x = fct_reorder(telecast, p_50_plus), y = p_50_plus,  fill = network)) + 
  geom_col() + 
  geom_text(aes(label = p_50_plus %>% round(2)), nudge_y = 0.15) + 
  scale_y_continuous(expand = expansion(mult = c(0, .1))) + 
  labs(x = "", title = "Top 10 Cable Shows for the 50+ Demographic",
       y = '',
       subtitle = "Wednesday, Feb 3rd 2021",
       caption = "*Source:* Showbuzzdaily.com",
       fill = '') + 
  coord_flip() + 
  cowplot::theme_cowplot() + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.line.x = element_blank(),
    plot.title.position = 'plot',
    plot.caption = ggtext::element_markdown(),
    legend.position = 'bottom'
  )

```

Interestingly in the 50+ Demo, *ALL* of the shows are News shows and they only come from 3 networks.  Two on CNN, Two on Fox News, and 6 on MSNBC.  Again, didn't have a ton of expectation but it was surprising to be how homogeneous the 50+ demography was.

